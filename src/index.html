<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Basketball GM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/ico/apple-touch-icon-57-precomposed.png">

    <script src="//d2wy8f7a9ursnm.cloudfront.net/v4/bugsnag.min.js"></script>

    <script async="async" src="https://www.googletagservices.com/tag/js/gpt.js"></script>
    <script async="async" src="https://basketball-gm.com/bbgm-ads/bbgm.js"></script>
    <script type="text/javascript">
      var googletag = googletag || {};
      googletag.cmd = googletag.cmd || [];
      var bbgmAds = bbgmAds || {};
      bbgmAds.cmd = bbgmAds.cmd || [];
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-38759330-1"></script>

    <script type="text/javascript">
      window.inCordova = document.URL.indexOf('file://') === 0;
      window.bbgmPrefix = window.inCordova ? "" : "/"; // Relative URLs for Cordova
      window.bbgmVersion = "REV_GOES_HERE";
      window.bbgmVersionUI = "???";
      window.bbgmVersionWorker = "???";
      window.useSharedWorker = typeof SharedWorker !== 'undefined';

      // .com or .dev TLD
      if (!window.inCordova) {
        var splitUrl = window.location.hostname.split('.');
        window.tld = splitUrl[splitUrl.length - 1];
      } else {
          // From within Cordova, window.location.hostname is not set, so always use .com
        window.tld = 'com';
      }

      function loadCSS(filename){
        var el = document.createElement("link");
        el.setAttribute("rel", "stylesheet");
        el.setAttribute("href", bbgmPrefix + filename);
        document.getElementsByTagName("head")[0].appendChild(el);
      }

      loadCSS("gen/bbgm2.css");

      window.enableLogging = location.host.indexOf("basketball-gm.com") >= 0 && location.pathname.indexOf("/test") === -1;

      if (window.enableLogging) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-38759330-1', {
          'cookie_domain': 'basketball-gm.com'
        });

        // Google Consumer Surveys
        var TriggerPrompt = function(articleUrl, contentId) {
          var ARTICLE_URL = articleUrl;
          var CONTENT_ID = contentId || '';
          var el = document.createElement('script');
          var url = '//survey.g.doubleclick.net/survey?site=5945171946504192' +
                    '&url=' + encodeURIComponent(ARTICLE_URL) +
                    (CONTENT_ID ? '&cid=' + encodeURIComponent(CONTENT_ID) : '') +
                    '&random=' + (new Date).getTime() +
                    '&after=1';
          el.setAttribute('src', url);
          var head = document.getElementsByTagName('head')[0] ||
              document.getElementsByTagName('body')[0];
          head.appendChild(el);
        };
      }

      var releaseStage = "unknown";
      if (location.host.indexOf("localhost") === 0) {
        releaseStage = "development";
      } else if (location.host.indexOf("beta.basketball-gm.com") === 0) {
        releaseStage = "beta";
      } else if (location.host.indexOf("play.basketball-gm.com") === 0) {
        releaseStage = "production";
      }

      window.bugsnagClient = window.bugsnag({
        apiKey: "c10b95290070cb8888a7a79cc5408555",
        appVersion: window.bbgmVersion,
        autoCaptureSessions: false,
        beforeSend: function (report) {
          // Normalize league URLs to all look the same
          if (report && typeof report.context === "string") {
            report.context = report.context.replace(/^\/l\/[0-9]+?\//, "/l/0/");
          }
        },
        notifyReleaseStages: ["beta", "production"],
        releaseStage: releaseStage
      });
    </script>
  </head>

  <body>

    <div id="content">
      <div id="loading-msg">
        <div style="max-width: 360px; margin: 0 auto;">
          <div style="margin: 0 15px; text-align: center">
            <h1>Loading...</h1>

            <p style="clear: both; margin-bottom: 6em"></p>

            <div style="margin: 0 -15px">
              <div class="team-picture-splash" id="team-picture-0"></div>
              <div class="team-picture-splash" id="team-picture-1"></div>
              <div class="team-picture-splash" id="team-picture-2"></div>
              <div class="team-picture-splash" id="team-picture-3"></div>
              <div class="team-picture-splash" id="team-picture-4"></div>
              <div class="team-picture-splash" id="team-picture-5"></div>
              <div class="team-picture-splash" id="team-picture-6"></div>
              <div class="team-picture-splash" id="team-picture-7"></div>
              <div class="team-picture-splash" id="team-picture-8"></div>
              <div class="team-picture-splash" id="team-picture-9"></div>
              <div class="team-picture-splash" id="team-picture-10"></div>
              <div class="team-picture-splash" id="team-picture-11"></div>
            </div>

          </div>
        </div>

        <p style="clear: both; margin-bottom: 6em"></p>

        <div class="container">
          <p>This should only take a few seconds on a fast connection.</p>
          <p style="margin-bottom: 0">If this gets stuck for a while, read the <a href="https://basketball-gm.com/manual/debugging/">the debugging instructions</a> and try to find an error message and <a href="https://basketball-gm.com/contact/">report a bug</a>.</p>
        </div>
      </div>
      <div class="container">
        <hr style="margin-bottom: 1.5em">

        <footer>
          <p>
              <a href="https://basketball-gm.com/about/" rel="noopener noreferrer" target="_blank">About</a> ·
              <a href="https://basketball-gm.com/advertise/" rel="noopener noreferrer" target="_blank">Advertise</a> ·
              <a href="https://basketball-gm.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a> ·
              <a href="https://basketball-gm.com/contact/" rel="noopener noreferrer" target="_blank">Contact</a> ·
              <a href="https://basketball-gm.com/privacy-policy/" rel="noopener noreferrer" target="_blank">Privacy Policy</a> ·
              <a href="https://basketball-gm.com/share/" rel="noopener noreferrer" target="_blank">Share</a><br />
          </p>
          <p class="rev">Component versions:<br>REV_GOES_HERE (HTML)<br><span id="version-ui">???</span> (UI)<br><span id="version-worker">???</span> (Worker)</p>
        </footer>
      </div>
    </div>

    <iframe style="display: none;" src="/manifest_hack"></iframe>

    <script>
      function shuffle(array) {
        var counter = array.length;
        while (counter > 0) {
          var index = Math.floor(Math.random() * counter);
          counter--;
          var temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
        }
        return array;
      }

      var abbrevs = shuffle(['ATL', 'BAL', 'BOS', 'CHI', 'CIN', 'CLE', 'DAL', 'DEN', 'DET', 'HOU', 'LV', 'LA', 'MXC', 'MIA', 'MIN', 'MON', 'NYC', 'PHI', 'PHO', 'PIT', 'POR', 'SAC', 'SD', 'SF', 'SEA', 'STL', 'TPA', 'TOR', 'VAN', 'WAS']);
      for (var i = 0; i < 12; i++) {
        document.getElementById('team-picture-' + i).style.backgroundImage = 'url(/img/logos/' + abbrevs[i] + '.png)';
      }

      // Browser compatibility checks! https://gist.github.com/jensarps/15f270874889e1717b3d
      var goodIDB = function (cb) {
        if (typeof window.indexedDB === "undefined") {
          cb(false);
          return;
        }

        var idb = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB;
        var keyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.mozIDBKeyRange;

        try {
          keyRange.only([1]);
        } catch (e) {
          cb(false);
          return;
        }

        var openRequest = idb.open('__detectIDB_test2', 1);

        openRequest.onupgradeneeded = function (evt) {
          var db = evt.target.result;
          var one = db.createObjectStore('one', {
            autoIncrement: true,
            keyPath: 'key'
          });
          one.createIndex('one', 'one');
          one.add({one: 1});
          var two = db.createObjectStore('two', {
            autoIncrement: true,
            keyPath: 'key'
          });
          two.createIndex ('two', 'two');
          two.add({two: 2});
        };

        openRequest.onsuccess = function (evt) {
          var db = evt.target.result;
          var transaction;
          try {
            transaction = db.transaction(['one', 'two'], 'readwrite');
          } catch (e) {
            cb(false);
            return;
          }

          var count = 0;
          transaction.objectStore('one').index('one').openCursor().onsuccess = function (evt) {
            cursor = evt.target.result;
            if (cursor) {
              count += 1;
              cursor.continue();
            }
          };

          transaction.oncomplete = function () {
            db.close();
            cb(count === 1); // Will be 2 in Safari 10 https://bugs.webkit.org/show_bug.cgi?id=158833
          };
        };
      };

      var supportsArrowFunctions = function () {
        try {
          eval('let f = x => 1');
          return true;
        } catch (err) {
          return false;
        }
      };

      var supportsSymbol = function () {
        try {
          eval("const s = Symbol();");
          return true;
        } catch (err) {
          return false;
        }
      };

      goodIDB(function (hasIDB) {
        if (!hasIDB || !supportsArrowFunctions() || !supportsSymbol()) {
          var errorMsg = '<p><b>Error!</b> Your browser is not modern enough to run Basketball GM. The latest versions of <a href="https://www.firefox.com/">Mozilla Firefox</a> and <a href="https://www.google.com/chrome/">Google Chrome</a> work best.</p>';
          var errorMsg = '<p><b>Error!</b> Your browser is not modern enough to run Basketball GM. The latest versions of <a href="https://www.firefox.com/">Mozilla Firefox</a> and <a href="https://www.google.com/chrome/">Google Chrome</a> work best.</p>';

          // Special error for Apple's mobile devices, as that's the only platform that is totally unsupported (no alternative browser to install)
          if (/(iPad|iPhone|iPod)/.test(navigator.userAgent)) {
            errorMsg += '<p>If you\'re on an iPhone/iPad, upgrade to iOS 10.3 or higher to play Basketball GM. If you can\'t do that, then please come back on a desktop/laptop or a non-Apple mobile device!</p>';
          }

          var loadingMsg = document.getElementById('loading-msg');
          loadingMsg.className = 'container';
          loadingMsg.innerHTML = '<div class="alert alert-danger" style="margin-bottom: 0">' + errorMsg + '</div>';
        } else {
          var body = document.getElementsByTagName('body').item(0);
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = bbgmPrefix + "gen/ui-" + bbgmVersion + ".js";
          body.appendChild(script);
        }
      });
    </script>
  </body>
</html>
